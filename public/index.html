<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Completo CRUD</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; display: flex; gap: 20px; }
        .form-container { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); height: fit-content; }
        .list-container { flex: 2; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 8px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        button { width: 100%; padding: 10px; color: white; border: none; cursor: pointer; border-radius: 4px; margin-bottom: 5px; }
        .btn-salvar { background-color: #28a745; }
        .btn-cancelar { background-color: #6c757d; display: none; }
        .actions-download { margin-top: 15px; display: flex; gap: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; }
        th { background-color: #f2f2f2; }
        .btn-editar { background-color: #ffc107; color: black; padding: 5px 10px; width: auto; }
        .btn-excluir { background-color: #dc3545; padding: 5px 10px; width: auto; }
    </style>
</head>
<body>

<div class="form-container">
    <h2 id="tituloForm">Novo Cadastro</h2>
    <form id="formCadastro">
        <input type="hidden" id="usuarioId">

        <h3>Dados Pessoais</h3>
        <input type="text" id="nome" placeholder="Nome Completo" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="senha" placeholder="Senha" required>

        <h3>Endereço</h3>
        <input type="text" id="rua" placeholder="Rua" required>
        <input type="text" id="bairro" placeholder="Bairro" required>

        <h3>Documentos</h3>
        <input type="text" id="cpf" placeholder="CPF" required>
        <input type="text" id="rg" placeholder="RG">
        <input type="text" id="cnh" placeholder="CNH">

        <button type="submit" class="btn-salvar" id="btnSalvar">Cadastrar</button>
        <button type="button" class="btn-cancelar" id="btnCancelar" onclick="limparFormulario()">Cancelar Edição</button>
    </form>

    <div class="actions-download">
        <button onclick="gerar('csv')" style="background-color: #17a2b8;">Baixar CSV</button>
        <button onclick="gerar('json')" style="background-color: #ffc107; color: black;">Baixar JSON</button>
        <button onclick="gerar('pdf')" style="background-color: #dc3545;">Baixar PDF</button>
    </div>
</div>

<div class="list-container">
    <h2>Usuários Cadastrados</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="tabelaCorpo">
            </tbody>
    </table>
</div>

<script>
    const form = document.getElementById('formCadastro');
    const tabela = document.getElementById('tabelaCorpo');

    carregarUsuarios();

    async function carregarUsuarios() {
        const res = await fetch('/usuarios');
        const usuarios = await res.json();
        tabela.innerHTML = '';

        usuarios.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.nome}</td>
                <td>${user.email}</td>
                <td>
                    <button class="btn-editar" onclick='prepararEdicao(${JSON.stringify(user)})'>Editar</button>
                    <button class="btn-excluir" onclick="excluirUsuario(${user.id})">Excluir</button>
                </td>
            `;
            tabela.appendChild(tr);
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('usuarioId').value;
        const dados = {
            nome: document.getElementById('nome').value,
            email: document.getElementById('email').value,
            senha: document.getElementById('senha').value,
            rua: document.getElementById('rua').value,
            bairro: document.getElementById('bairro').value,
            cpf: document.getElementById('cpf').value,
            rg: document.getElementById('rg').value,
            cnh: document.getElementById('cnh').value
        };

        let url = '/cadastrar';
        let method = 'POST';

        if (id) {
            url = `/usuarios/${id}`;
            method = 'PUT';
        }

        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });

        const result = await res.json();
        alert(result.message || result.error);
        
        limparFormulario();
        carregarUsuarios();
    });

    // Formulário edição
    function prepararEdicao(user) {
        document.getElementById('usuarioId').value = user.id;
        document.getElementById('nome').value = user.nome;
        document.getElementById('email').value = user.email;
        document.getElementById('senha').value = user.senha;
        document.getElementById('rua').value = user.rua;
        document.getElementById('bairro').value = user.bairro;
        document.getElementById('cpf').value = user.cpf;
        document.getElementById('rg').value = user.rg;
        document.getElementById('cnh').value = user.cnh;
        document.getElementById('tituloForm').innerText = "Editando Usuário " + user.id;
        document.getElementById('btnSalvar').innerText = "Salvar Alterações";
        document.getElementById('btnCancelar').style.display = "inline-block";
    }

    // Excluir usuário
    async function excluirUsuario(id) {
        if(confirm('Tem certeza que deseja excluir este usuário?')) {
            const res = await fetch(`/usuarios/${id}`, { method: 'DELETE' });
            const result = await res.json();
            alert(result.message);
            carregarUsuarios();
        }
    }

    // Limpar formulário
    function limparFormulario() {
        form.reset();
        document.getElementById('usuarioId').value = "";
        document.getElementById('tituloForm').innerText = "Novo Cadastro";
        document.getElementById('btnSalvar').innerText = "Cadastrar";
        document.getElementById('btnCancelar').style.display = "none";
    }

    function gerar(tipo) {
        window.location.href = `/gerar-${tipo}`;
    }
</script>

</body>
</html>